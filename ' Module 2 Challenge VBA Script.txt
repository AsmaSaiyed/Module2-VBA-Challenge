' Module 2 Challenge VBA Script
Sub VBAStocks()

' To loop it to work through each worksheet in the file
For Each ws In Worksheets


' Assigning dimensions as needed and assigning initial value 
Dim tickername As String
Dim STOCKvolume As Double
STOCKvolume = 0
Dim newtable As Integer
newtable = 2
Dim OpenPrice As Double
Dim ClosePrice As Double
Dim totalPrice As Double
totalPrice = 0
Dim PercentChange As Double
Dim Volume As Double
Dim Row As Long
Dim LastRow As Long

'Column headers for New Table
ws.Range("I1").Value = "Ticker"
ws.Range("J1").Value = "Yearly change"
ws.Range("k1").Value = "Percent Change"
ws.Range("L1").Value = "Total Stock Volume"

'finding the opening value of the Stock
OpenPrice = ws.Cells(2, 3).Value

'getting the row number of the last row with data and establish a value for it
LastRow = Cells(Rows.Count, "A").End(xlUp).Row 

'for all the rows in the data with the same ticker
For Row = 2 To LastRow


'set the ticker name
tickername = ws.Cells(Row, 1).Value

'add to the ticker volume
totalPrice = totalPrice + ws.Cells(Row, 7).Value

'finding the total ticker value
If ws.Cells(Row + 1, 1).Value <> ws.Cells(Row, 1) Then
ws.Cells(newtable, 9) = tickername
STOCKvolume = STOCKvolume + ws.Cells(Row, 7).Value
ws.Cells(newtable, 12).Value = STOCKvolume
ClosePrice = ws.Cells(Row, 6).Value

ws.Cells(newtable, 10).Value = ClosePrice - OpenPrice
ws.Cells(newtable, 11).Value = ((ClosePrice - OpenPrice) / OpenPrice)
ws.Cells(newtable, 11).NumberFormat = "0.00%"

'finding the new opening value
OpenPrice = ws.Cells(Row + 1, 3).value
STOCKvolume = 0

newtable = newtable + 1

Else

STOCKvolume = STOCKvolume + ws.Cells(Row, 7).Value

 End If
 
' to change the colour based on the conditions
If ws.Cells(newtable, 10).Value >= 0 Then
ws.Cells(newtable, 10).Interior.ColorIndex = 4
'change to colour green
Else
ws.Cells(newtable, 10).Interior.ColorIndex = 3
' change to colour red
End If

' setting it to restart for thr next set of tickers
Next Row

Next ws


For Each ws In Worksheets

Range("N2").Value = "Greatest % Increase"
Range("N3").Value = "Greatest % Decrease"
Range("N4").Value = "Greatest Total Volume"
Range("O1").Value = "Ticker"
Range("P1").Value = "Value"

Next ws

End Sub